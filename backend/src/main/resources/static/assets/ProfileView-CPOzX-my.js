import{r as i,a as m,j as e,g as A}from"./index-B_cI0C2E.js";const g=r=>{if(!r)return null;if(r.startsWith("http://")||r.startsWith("https://"))return r;try{return A().getFullUrl(r)}catch{return r.startsWith("/")?r:`/upload/${r}`}};function G(){const[r,d]=i.useState({uuid:"",username:"",avatar:"",phone:"",email:"",gender:"",birthday:""}),[y,p]=i.useState(!0),[h,f]=i.useState(!1),[b,x]=i.useState(""),[j,v]=i.useState(""),[N,o]=i.useState("/default-avatar.png");i.useEffect(()=>{w()},[]);const w=async()=>{try{p(!0);const t=await m.get("/user/status");if(t&&t.loggedIn){const a=await m.get(`/user/uuid?username=${t.username}`);if(a&&a.uuid){const s=await m.get(`/user/${a.uuid}`);if(s){const n=s.birthday?s.birthday.substring(0,10):"",u=s.avatar?g(s.avatar):"/default-avatar.png";d({uuid:s.uuid||"",username:s.username||"",avatar:s.avatar||"",phone:s.phone||"",email:s.email||"",gender:s.gender||"",birthday:n}),o(u||"/default-avatar.png")}}}}catch(t){console.error("获取用户信息失败:",t),l("获取用户信息失败","error"),o("/default-avatar.png")}finally{p(!1)}},c=t=>{const{name:a,value:s}=t.target;d(n=>({...n,[a]:s}))},F=async t=>{const a=t.target.files[0];if(!a)return;if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(a.type)){l("请选择有效的图片文件 (JPG, JPEG, PNG, GIF, WebP)","error");return}if(a.size>5*1024*1024){l("文件大小不能超过5MB","error");return}const n=new FileReader;n.onload=u=>{o(u.target.result)},n.readAsDataURL(a),await C(a)},C=async t=>{try{const a=new FormData;a.append("file",t);const s=await m.post("/uploadavatar",a,{headers:{"Content-Type":"multipart/form-data"}});if(s&&s.fileUrl){d(u=>({...u,avatar:s.fileUrl}));const n=g(s.fileUrl);o(n||"/default-avatar.png"),l("头像上传成功","success")}else{l("头像上传失败","error");const n=r.avatar?g(r.avatar):"/default-avatar.png";o(n)}}catch(a){console.error("头像上传错误:",a),l("头像上传失败: "+(a.response?.data?.error||a.message),"error");const s=r.avatar?g(r.avatar):"/default-avatar.png";o(s)}},P=async t=>{t.preventDefault();try{f(!0);const a={uuid:r.uuid};r.username&&(a.username=r.username),r.avatar&&(a.avatar=r.avatar),r.phone&&(a.phone=r.phone),r.email&&(a.email=r.email),r.gender&&(a.gender=r.gender),r.birthday&&(a.birthday=r.birthday),await m.put("/user/update",a)?l("个人信息更新成功","success"):l("更新失败","error")}catch(a){console.error("更新用户信息失败:",a),l("更新用户信息失败: "+(a.response?.data?.message||a.message),"error")}finally{f(!1)}},l=(t,a)=>{x(t),v(a),setTimeout(()=>{x(""),v("")},3e3)};return y?e.jsx("div",{className:"bg-white rounded-lg shadow-sm p-6",children:e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"加载中..."})]})}):e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-6",children:"个人中心"}),b&&e.jsx("div",{className:`mb-6 p-4 rounded-lg ${j==="success"?"bg-green-50 text-green-800":"bg-red-50 text-red-800"}`,children:b}),e.jsxs("form",{onSubmit:P,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700 mb-1",children:"用户名"}),e.jsx("input",{type:"text",id:"username",name:"username",value:r.username,onChange:c,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入用户名"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"头像"}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsx("div",{className:"relative",children:e.jsx("img",{src:N,alt:"头像预览",className:"w-16 h-16 rounded-full object-cover border-2 border-gray-300",onError:t=>{t.target.src="/default-avatar.png"}})}),e.jsxs("div",{children:[e.jsxs("label",{className:"bg-blue-600 text-white px-4 py-2 rounded-md cursor-pointer hover:bg-blue-700 transition-colors",children:["选择图片",e.jsx("input",{type:"file",className:"hidden",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:F})]}),e.jsx("p",{className:"mt-2 text-gray-500 text-xs",children:"支持 JPG, JPEG, PNG, GIF, WebP 格式，最大5MB"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"邮箱"}),e.jsx("input",{type:"email",id:"email",name:"email",value:r.email,onChange:c,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入邮箱"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:"手机号"}),e.jsx("input",{type:"tel",id:"phone",name:"phone",value:r.phone,onChange:c,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入手机号"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"gender",className:"block text-sm font-medium text-gray-700 mb-1",children:"性别"}),e.jsxs("select",{id:"gender",name:"gender",value:r.gender,onChange:c,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"请选择性别"}),e.jsx("option",{value:"male",children:"男"}),e.jsx("option",{value:"female",children:"女"}),e.jsx("option",{value:"other",children:"其他"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"birthday",className:"block text-sm font-medium text-gray-700 mb-1",children:"生日"}),e.jsx("input",{type:"date",id:"birthday",name:"birthday",value:r.birthday,onChange:c,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"submit",disabled:h,className:"px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50",children:h?"保存中...":"保存更改"})})]})]})}export{G as default};
