import{r as d,a as g,j as e,g as G}from"./index-TNuvMK4e.js";const h=a=>{if(!a)return null;if(a.startsWith("http://")||a.startsWith("https://"))return a;try{return G().getFullUrl(a)}catch{return a.startsWith("/")?a:`/upload/${a}`}},p=a=>a&&a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),i=a=>a&&a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'");function k(){const[a,u]=d.useState({uuid:"",username:"",avatar:"",phone:"",email:"",gender:"",birthday:""}),[N,f]=d.useState(!0),[b,x]=d.useState(!1),[v,y]=d.useState(""),[w,j]=d.useState(""),[F,c]=d.useState("/default-avatar.png");d.useEffect(()=>{C()},[]);const C=async()=>{try{f(!0);const s=await g.get("/user/status");if(s&&s.loggedIn){const r=await g.get(`/user/uuid?username=${s.username}`);if(r&&r.uuid){const t=await g.get(`/user/${r.uuid}`);if(t){const n=t.birthday?t.birthday.substring(0,10):"",o=t.avatar?h(t.avatar):"/default-avatar.png";u({uuid:t.uuid||"",username:p(t.username)||"",avatar:t.avatar||"",phone:p(t.phone)||"",email:p(t.email)||"",gender:p(t.gender)||"",birthday:n}),c(o||"/default-avatar.png")}}}}catch{l("获取用户信息失败","error"),c("/default-avatar.png")}finally{f(!1)}},m=s=>{const{name:r,value:t}=s.target,n=p(t);u(o=>({...o,[r]:n}))},P=async s=>{const r=s.target.files[0];if(!r)return;if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(r.type)){l("请选择有效的图片文件 (JPG, JPEG, PNG, GIF, WebP)","error");return}if(r.size>5*1024*1024){l("文件大小不能超过5MB","error");return}const n=new FileReader;n.onload=o=>{c(o.target.result)},n.readAsDataURL(r),await A(r)},A=async s=>{try{const r=new FormData;r.append("file",s);const t=await g.post("/uploadavatar",r,{headers:{"Content-Type":"multipart/form-data"}});if(t&&t.fileUrl){u(o=>({...o,avatar:t.fileUrl}));const n=h(t.fileUrl);c(n||"/default-avatar.png"),l("头像上传成功","success")}else{l("头像上传失败","error");const n=a.avatar?h(a.avatar):"/default-avatar.png";c(n)}}catch(r){l("头像上传失败: "+(r.response?.data?.error||r.message),"error");const t=a.avatar?h(a.avatar):"/default-avatar.png";c(t)}},S=async s=>{s.preventDefault();try{x(!0);const r={uuid:a.uuid,username:i(a.username),avatar:a.avatar,phone:i(a.phone),email:i(a.email),gender:i(a.gender),birthday:a.birthday};await g.put("/user/update",r)?l("个人信息更新成功","success"):l("更新失败","error")}catch(r){l("更新用户信息失败: "+(r.response?.data?.message||r.message),"error")}finally{x(!1)}},l=(s,r)=>{y(s),j(r),setTimeout(()=>{y(""),j("")},3e3)};return N?e.jsx("div",{className:"bg-white rounded-lg shadow-sm p-6",children:e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"加载中..."})]})}):e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-6",children:"个人中心"}),v&&e.jsx("div",{className:`mb-6 p-4 rounded-lg ${w==="success"?"bg-green-50 text-green-800":"bg-red-50 text-red-800"}`,children:v}),e.jsxs("form",{onSubmit:S,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700 mb-1",children:"用户名"}),e.jsx("input",{type:"text",id:"username",name:"username",value:i(a.username),onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入用户名"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"头像"}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsx("div",{className:"relative",children:e.jsx("img",{src:F,alt:"头像预览",className:"w-16 h-16 rounded-full object-cover border-2 border-gray-300",onError:s=>{s.target.src="/default-avatar.png"}})}),e.jsxs("div",{children:[e.jsxs("label",{className:"bg-blue-600 text-white px-4 py-2 rounded-md cursor-pointer hover:bg-blue-700 transition-colors",children:["选择图片",e.jsx("input",{type:"file",className:"hidden",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:P})]}),e.jsx("p",{className:"mt-2 text-gray-500 text-xs",children:"支持 JPG, JPEG, PNG, GIF, WebP 格式，最大5MB"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"邮箱"}),e.jsx("input",{type:"email",id:"email",name:"email",value:i(a.email),onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入邮箱"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:"手机号"}),e.jsx("input",{type:"tel",id:"phone",name:"phone",value:i(a.phone),onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入手机号"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"gender",className:"block text-sm font-medium text-gray-700 mb-1",children:"性别"}),e.jsxs("select",{id:"gender",name:"gender",value:i(a.gender),onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"请选择性别"}),e.jsx("option",{value:"male",children:"男"}),e.jsx("option",{value:"female",children:"女"}),e.jsx("option",{value:"other",children:"其他"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"birthday",className:"block text-sm font-medium text-gray-700 mb-1",children:"生日"}),e.jsx("input",{type:"date",id:"birthday",name:"birthday",value:a.birthday,onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"submit",disabled:b,className:"px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50",children:b?"保存中...":"保存更改"})})]})]})}export{k as default};
