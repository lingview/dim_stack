import{r as c,a as p,j as e,g as G}from"./index-Ce4CSjDS.js";const h=a=>{if(!a)return null;if(a.startsWith("http://")||a.startsWith("https://"))return a;try{return G().getFullUrl(a)}catch{return a.startsWith("/")?a:`/upload/${a}`}},g=a=>a&&a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),o=a=>a&&a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'");function k(){const[a,i]=c.useState({uuid:"",username:"",avatar:"",phone:"",email:"",gender:"",birthday:"",password:""}),[w,f]=c.useState(!0),[b,x]=c.useState(!1),[v,y]=c.useState(""),[N,j]=c.useState(""),[F,u]=c.useState("/default-avatar.png");c.useEffect(()=>{C()},[]);const C=async()=>{try{f(!0);const t=await p.get("/user/status");if(t.code===200&&t.data.loggedIn){const r=await p.get(`/user/uuid?username=${t.data.username}`);if(r&&r.uuid){const s=await p.get(`/user/${r.uuid}`);if(s){const n=s.birthday?s.birthday.substring(0,10):"",d=s.avatar?h(s.avatar):"/default-avatar.png";i({uuid:s.uuid||"",username:g(s.username)||"",avatar:s.avatar||"",phone:g(s.phone)||"",email:g(s.email)||"",gender:g(s.gender)||"",birthday:n}),u(d||"/default-avatar.png")}}}}catch{l("获取用户信息失败","error"),u("/default-avatar.png")}finally{f(!1)}},m=t=>{const{name:r,value:s}=t.target;if(r==="password")i(n=>({...n,[r]:s}));else{const n=g(s);i(d=>({...d,[r]:n}))}},P=async t=>{const r=t.target.files[0];if(!r)return;if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(r.type)){l("请选择有效的图片文件 (JPG, JPEG, PNG, GIF, WebP)","error");return}if(r.size>5*1024*1024){l("文件大小不能超过5MB","error");return}const n=new FileReader;n.onload=d=>{u(d.target.result)},n.readAsDataURL(r),await A(r)},A=async t=>{try{const r=new FormData;r.append("file",t);const s=await p.post("/uploadavatar",r,{headers:{"Content-Type":"multipart/form-data"}});if(s&&s.fileUrl){i(d=>({...d,avatar:s.fileUrl}));const n=h(s.fileUrl);u(n||"/default-avatar.png"),l("头像上传成功","success")}else{l("头像上传失败","error");const n=a.avatar?h(a.avatar):"/default-avatar.png";u(n)}}catch(r){l("头像上传失败: "+(r.response?.data?.error||r.message),"error");const s=a.avatar?h(a.avatar):"/default-avatar.png";u(s)}},S=async t=>{t.preventDefault();try{x(!0);const r={uuid:a.uuid,username:o(a.username),avatar:a.avatar,phone:o(a.phone),email:o(a.email),gender:o(a.gender),birthday:a.birthday,password:a.password};await p.put("/user/update",r)?(l("个人信息更新成功","success"),i(n=>({...n,password:""}))):l("更新失败","error")}catch(r){l("更新用户信息失败: "+(r.response?.data?.message||r.message),"error")}finally{x(!1)}},l=(t,r)=>{y(t),j(r),setTimeout(()=>{y(""),j("")},3e3)};return w?e.jsx("div",{className:"bg-white rounded-lg shadow-sm p-6",children:e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"加载中..."})]})}):e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-6",children:"个人中心"}),v&&e.jsx("div",{className:`mb-6 p-4 rounded-lg ${N==="success"?"bg-green-50 text-green-800":"bg-red-50 text-red-800"}`,children:v}),e.jsxs("form",{onSubmit:S,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700 mb-1",children:"用户名"}),e.jsx("input",{type:"text",id:"username",name:"username",value:o(a.username),onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入用户名"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"头像"}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsx("div",{className:"relative",children:e.jsx("img",{src:F,alt:"头像预览",className:"w-16 h-16 rounded-full object-cover border-2 border-gray-300",onError:t=>{t.target.src="/default-avatar.png"}})}),e.jsxs("div",{children:[e.jsxs("label",{className:"bg-blue-600 text-white px-4 py-2 rounded-md cursor-pointer hover:bg-blue-700 transition-colors",children:["选择图片",e.jsx("input",{type:"file",className:"hidden",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:P})]}),e.jsx("p",{className:"mt-2 text-gray-500 text-xs",children:"支持 JPG, JPEG, PNG, GIF, WebP 格式，最大5MB"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-1",children:"新密码"}),e.jsx("input",{type:"password",id:"password",name:"password",value:a.password,onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入新密码"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"邮箱"}),e.jsx("input",{type:"email",id:"email",name:"email",value:o(a.email),onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入邮箱"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:"手机号"}),e.jsx("input",{type:"tel",id:"phone",name:"phone",value:o(a.phone),onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入手机号"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"gender",className:"block text-sm font-medium text-gray-700 mb-1",children:"性别"}),e.jsxs("select",{id:"gender",name:"gender",value:o(a.gender),onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"请选择性别"}),e.jsx("option",{value:"male",children:"男"}),e.jsx("option",{value:"female",children:"女"}),e.jsx("option",{value:"other",children:"其他"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"birthday",className:"block text-sm font-medium text-gray-700 mb-1",children:"生日"}),e.jsx("input",{type:"date",id:"birthday",name:"birthday",value:a.birthday,onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"submit",disabled:b,className:"px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50",children:b?"保存中...":"保存更改"})})]})]})}export{k as default};
